<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Dashboard - Friendly UI</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtdmsd0gWLPqwNpRI2lpiif_FuG-PTHjQ",
  authDomain: "ao-asset.firebaseapp.com",
  projectId: "ao-asset",
  storageBucket: "ao-asset.firebasestorage.app",
  messagingSenderId: "406786910363",
  appId: "1:406786910363:web:1d837738aab6c6b9d73e3e",
  measurementId: "G-4H7RF76176"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allAssets = [];
let currentFilteredAssets = [];
let currentTab = 'all';

async function fetchAssets() {
  const snapshot = await getDocs(collection(db,'assets'));
  allAssets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  currentFilteredAssets = [...allAssets];
  populateDropdowns();
  populateTabs();
  renderSummary();
  renderAssets(currentFilteredAssets);
}

function populateDropdowns() {
  const unique = (field) => [...new Set(allAssets.map(a => a[field]))].sort();

  const categorySel = document.getElementById('filterCategory');
  const locationSel = document.getElementById('filterLocation');
  const manufacturerSel = document.getElementById('filterManufacturer');
  const amcVendorSel = document.getElementById('filterAmcVendor');

  categorySel.innerHTML = '<option value="">All Categories</option>';
  unique('category').forEach(c => categorySel.innerHTML += `<option value="${c}">${c}</option>`);

  locationSel.innerHTML = '<option value="">All Locations</option>';
  unique('location').forEach(l => locationSel.innerHTML += `<option value="${l}">${l}</option>`);

  manufacturerSel.innerHTML = '<option value="">All Manufacturers</option>';
  unique('manufacturer').forEach(m => manufacturerSel.innerHTML += `<option value="${m}">${m}</option>`);

  amcVendorSel.innerHTML = '<option value="">All AMC Vendors</option>';
  unique('amcVendor').forEach(v => amcVendorSel.innerHTML += `<option value="${v}">${v}</option>`);
}

function populateTabs() {
  const tabsContainer = document.getElementById('tabs');
  const blocks = [...new Set(allAssets.map(a => a.location.split(',')[0]))];
  tabsContainer.innerHTML = '';

  const allBtn = document.createElement('button');
  allBtn.textContent = 'All';
  allBtn.className = 'px-4 py-2 rounded transition';
  allBtn.onclick = () => applyTab('all');
  tabsContainer.appendChild(allBtn);

  blocks.forEach(b => {
    const btn = document.createElement('button');
    btn.textContent = b;
    btn.className = 'px-4 py-2 rounded transition';
    btn.onclick = () => applyTab(b);
    tabsContainer.appendChild(btn);
  });

  highlightCurrentTab();
}

function highlightCurrentTab() {
  const buttons = document.getElementById('tabs').children;
  for (let btn of buttons) {
    if (btn.textContent === currentTab || (currentTab==='all' && btn.textContent==='All')) {
      btn.classList.add('bg-blue-500','text-white','shadow-lg');
      btn.classList.remove('bg-gray-200');
    } else {
      btn.classList.remove('bg-blue-500','text-white','shadow-lg');
      btn.classList.add('bg-gray-200');
    }
  }
}

function applyFilters() {
  const cat = document.getElementById('filterCategory').value;
  const loc = document.getElementById('filterLocation').value;
  const man = document.getElementById('filterManufacturer').value;
  const amc = document.getElementById('filterAmcVendor').value;

  currentFilteredAssets = allAssets.filter(a => 
    (currentTab === 'all' || a.location.startsWith(currentTab)) &&
    (cat === '' || a.category === cat) &&
    (loc === '' || a.location === loc) &&
    (man === '' || a.manufacturer === man) &&
    (amc === '' || a.amcVendor === amc)
  );

  renderSummary();
  renderAssets(currentFilteredAssets);
}

function applySort() {
  const sortKey = document.getElementById('sortAssets').value;
  currentFilteredAssets.sort((a,b) => {
    if(a[sortKey] < b[sortKey]) return -1;
    if(a[sortKey] > b[sortKey]) return 1;
    return 0;
  });
  renderAssets(currentFilteredAssets);
}

function applyTab(block) {
  currentTab = block;
  highlightCurrentTab();
  applyFilters();
}

function renderAssets(assets) {
  const container = document.getElementById('assetList');
  container.innerHTML = '';
  if (assets.length === 0) {
    container.innerHTML = '<p class="text-center text-gray-500">No assets found</p>';
    return;
  }
  assets.forEach(a => {
    const div = document.createElement('div');
    div.className = 'border p-4 rounded shadow bg-white hover:shadow-xl transition';
    div.innerHTML = `
      <p class="font-bold">${a.assetCode}</p>
      <p>${a.assetName} (${a.assetShort})</p>
      <p>
        <strong>Category:</strong> ${a.category} 
      </p>
      <p>
        <strong>Location:</strong> ${a.location} (${a.locationShort})
      </p>
      <p>
        <strong>Manufacturer:</strong> <span class="cursor-pointer text-blue-600 hover:underline" onclick="filterByManufacturer('${a.manufacturer}')">${a.manufacturer}</span>
      </p>
      <p><strong>Installed:</strong> ${a.installationDate}</p>
      <p><strong>AMC Vendor:</strong> ${a.amcVendor}</p>
      <p><strong>AMC Start:</strong> ${a.amcStart} | <strong>End:</strong> ${a.amcEnd}</p>
    `;
    container.appendChild(div);
  });
}

function filterByManufacturer(name) {
  document.getElementById('filterManufacturer').value = name;
  applyFilters();
}

function renderSummary() {
  const total = currentFilteredAssets.length;
  const byBlock = {};
  currentFilteredAssets.forEach(a => {
    const block = a.location.split(',')[0];
    byBlock[block] = (byBlock[block] || 0) + 1;
  });

  let html = `<p class="font-bold mb-2">Total Assets: ${total}</p>`;
  html += '<p class="mb-2">Assets by Block:</p><ul class="list-disc ml-5">';
  for(const b in byBlock) html += `<li>${b}: ${byBlock[b]}</li>`;
  html += '</ul>';
  document.getElementById('summary').innerHTML = html;
}

window.addEventListener('DOMContentLoaded', fetchAssets);
window.applyFilters = applyFilters;
window.applySort = applySort;
window.applyTab = applyTab;
window.filterByManufacturer = filterByManufacturer;

</script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 min-h-screen">
<div class="max-w-6xl mx-auto">

  <h1 class="text-2xl font-bold mb-4 text-center">Asset Dashboard</h1>

  <!-- Tabs -->
  <div id="tabs" class="flex flex-wrap gap-2 mb-4"></div>

  <!-- Filters -->
  <div class="flex flex-wrap gap-2 mb-4">
    <select id="filterCategory" onchange="applyFilters()" class="border p-2 rounded flex-1"></select>
    <select id="filterLocation" onchange="applyFilters()" class="border p-2 rounded flex-1"></select>
    <select id="filterManufacturer" onchange="applyFilters()" class="border p-2 rounded flex-1"></select>
    <select id="filterAmcVendor" onchange="applyFilters()" class="border p-2 rounded flex-1"></select>
    <select id="sortAssets" onchange="applySort()" class="border p-2 rounded flex-1">
      <option value="assetCode">Sort by Asset Code</option>
      <option value="assetName">Sort by Asset Name</option>
      <option value="installationDate">Sort by Installation Date</option>
    </select>
  </div>

  <!-- Summary -->
  <div id="summary" class="bg-white p-4 rounded mb-4 shadow"></div>

  <!-- Asset List -->
  <div id="assetList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

</div>
</body>
</html>
