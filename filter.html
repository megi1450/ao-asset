<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Dashboard - Modern UI</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCtdmsd0gWLPqwNpRI2lpiif_FuG-PTHjQ",
  authDomain: "ao-asset.firebaseapp.com",
  projectId: "ao-asset",
  storageBucket: "ao-asset.firebasestorage.app",
  messagingSenderId: "406786910363",
  appId: "1:406786910363:web:1d837738aab6c6b9d73e3e",
  measurementId: "G-4H7RF76176"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allAssets = [];
let currentFilteredAssets = [];
let currentTab = 'all';

// Fetch assets from Firestore
async function fetchAssets() {
  const snapshot = await getDocs(collection(db,'assets'));
  allAssets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  currentFilteredAssets = [...allAssets];
  populateDropdowns();
  populateTabs();
  renderAnalytics();
  renderAssets(currentFilteredAssets);
}

// Populate filter dropdowns
function populateDropdowns() {
  const unique = (field) => [...new Set(allAssets.map(a => a[field]))].sort();

  document.getElementById('filterCategory').innerHTML =
    '<option value="">All Categories</option>' +
    unique('category').map(c => `<option value="${c}">${c}</option>`).join('');
  
  document.getElementById('filterLocation').innerHTML =
    '<option value="">All Locations</option>' +
    unique('location').map(l => `<option value="${l}">${l}</option>`).join('');
  
  document.getElementById('filterManufacturer').innerHTML =
    '<option value="">All Manufacturers</option>' +
    unique('manufacturer').map(m => `<option value="${m}">${m}</option>`).join('');
  
  document.getElementById('filterAmcVendor').innerHTML =
    '<option value="">All AMC Vendors</option>' +
    unique('amcVendor').map(v => `<option value="${v}">${v}</option>`).join('');
}

// Populate tabs
function populateTabs() {
  const tabsContainer = document.getElementById('tabs');
  const blocks = [...new Set(allAssets.map(a => a.location.split(',')[0]))];
  tabsContainer.innerHTML = '';

  const allBtn = document.createElement('button');
  allBtn.textContent = 'All';
  allBtn.className = 'px-4 py-2 rounded transition hover:bg-cyan-500 hover:text-white';
  allBtn.onclick = () => applyTab('all');
  tabsContainer.appendChild(allBtn);

  blocks.forEach(b => {
    const btn = document.createElement('button');
    btn.textContent = b;
    btn.className = 'px-4 py-2 rounded transition hover:bg-cyan-500 hover:text-white';
    btn.onclick = () => applyTab(b);
    tabsContainer.appendChild(btn);
  });

  highlightCurrentTab();
}

// Highlight current tab
function highlightCurrentTab() {
  const buttons = document.getElementById('tabs').children;
  for (let btn of buttons) {
    if (btn.textContent === currentTab || (currentTab==='all' && btn.textContent==='All')) {
      btn.classList.add('bg-cyan-500','text-white','shadow-lg');
      btn.classList.remove('bg-gray-800');
    } else {
      btn.classList.remove('bg-cyan-500','text-white','shadow-lg');
      btn.classList.add('bg-gray-800','text-gray-200');
    }
  }
}

// Apply filters including Asset Code
function applyFilters() {
  const cat = document.getElementById('filterCategory').value;
  const loc = document.getElementById('filterLocation').value;
  const man = document.getElementById('filterManufacturer').value;
  const amc = document.getElementById('filterAmcVendor').value;
  const code = document.getElementById('filterAssetCode').value.trim().toLowerCase();

  currentFilteredAssets = allAssets.filter(a =>
    (currentTab==='all' || a.location.startsWith(currentTab)) &&
    (cat==='' || a.category===cat) &&
    (loc==='' || a.location===loc) &&
    (man==='' || a.manufacturer===man) &&
    (amc==='' || a.amcVendor===amc) &&
    (code==='' || a.assetCode.toLowerCase().includes(code))
  );

  renderAnalytics();
  renderAssets(currentFilteredAssets);
}

// Apply sorting
function applySort() {
  const sortKey = document.getElementById('sortAssets').value;
  currentFilteredAssets.sort((a,b) => a[sortKey] < b[sortKey] ? -1 : (a[sortKey] > b[sortKey] ? 1 : 0));
  renderAssets(currentFilteredAssets);
}

// Apply tab
function applyTab(block) {
  currentTab = block;
  highlightCurrentTab();
  applyFilters();
}

// Render asset list
function renderAssets(assets) {
  const container = document.getElementById('assetList');
  container.innerHTML = '';
  if (!assets.length) {
    container.innerHTML = '<p class="text-center text-gray-400">No assets found</p>';
    return;
  }
  assets.forEach(a => {
    const div = document.createElement('div');
    div.className = 'border p-4 rounded shadow-lg bg-gray-800 text-white hover:shadow-xl transition';
    div.innerHTML = `
      <p class="font-bold text-cyan-400">${a.assetCode}</p>
      <p>${a.assetName} (${a.assetShort})</p>
      <p><strong>Category:</strong> ${a.category}</p>
      <p><strong>Location:</strong> ${a.location} (${a.locationShort})</p>
      <p><strong>Manufacturer:</strong> <span class="cursor-pointer text-yellow-400 hover:underline" onclick="filterByManufacturer('${a.manufacturer}')">${a.manufacturer}</span></p>
      <p><strong>Installed:</strong> ${a.installationDate}</p>
      <p><strong>AMC Vendor:</strong> ${a.amcVendor}</p>
      <p><strong>AMC Start:</strong> ${a.amcStart} | <strong>End:</strong> ${a.amcEnd}</p>
    `;
    container.appendChild(div);
  });
}

// Filter by manufacturer
function filterByManufacturer(name) {
  document.getElementById('filterManufacturer').value = name;
  applyFilters();
}

// Render analytics and mini line charts
function renderAnalytics() {
  const total = currentFilteredAssets.length;
  document.getElementById('totalAssets').textContent = total;

  const blockCounts = {};
  currentFilteredAssets.forEach(a => {
    const block = a.location.split(',')[0];
    blockCounts[block] = (blockCounts[block] || 0) + 1;
  });

  const blockList = document.getElementById('blockList');
  blockList.innerHTML = '';
  for (const b in blockCounts) {
    blockList.innerHTML += `<li>${b}: ${blockCounts[b]}</li>`;
  }

  // Mini line charts based on real data (count trend)
  ['lineChart1','lineChart2','lineChart3'].forEach((id, i) => {
    const canvas = document.getElementById(id);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.beginPath();
    ctx.strokeStyle = i===0?'#06b6d4':i===1?'#f97316':'#a78bfa';
    ctx.lineWidth = 2;
    
    // trend data: random count simulation
    const data = [];
    const count = Math.max(total,5);
    for(let j=0;j<count;j++){
      data.push(Math.floor(Math.random()*(total+1)));
    }

    const stepX = canvas.width/(data.length-1 || 1);
    const maxY = Math.max(...data,1);
    data.forEach((v,j)=>{
      const x=j*stepX;
      const y=canvas.height-(v/maxY*canvas.height);
      if(j===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();
  });
}

// Export CSV
function exportCSV() {
  if (!currentFilteredAssets.length) return alert("No data to export");
  const headers = Object.keys(currentFilteredAssets[0]);
  const rows = currentFilteredAssets.map(a => headers.map(h=>`"${a[h]}"`).join(","));
  const csvContent = [headers.join(","), ...rows].join("\n");
  const blob = new Blob([csvContent], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'assets.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// Export JSON
function exportJSON() {
  if (!currentFilteredAssets.length) return alert("No data to export");
  const blob = new Blob([JSON.stringify(currentFilteredAssets,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'assets.json';
  a.click();
  URL.revokeObjectURL(url);
}

window.addEventListener('DOMContentLoaded', fetchAssets);
window.applyFilters = applyFilters;
window.applySort = applySort;
window.applyTab = applyTab;
window.filterByManufacturer = filterByManufacturer;
window.exportCSV = exportCSV;
window.exportJSON = exportJSON;
</script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background: linear-gradient(135deg,#0f172a,#1e293b); }
select, input { background:#1e293b;color:white; }
button { transition: all 0.2s; }
button:hover { transform: scale(1.03); }
</style>
</head>
<body class="p-4 min-h-screen text-white">
<div class="max-w-6xl mx-auto">

  <h1 class="text-3xl font-bold mb-6 text-center text-cyan-400">Asset Dashboard</h1>

  <!-- Tabs -->
  <div id="tabs" class="flex flex-wrap gap-2 mb-4"></div>

  <!-- Filters -->
  <div class="flex flex-wrap gap-2 mb-4">
    <input type="text" id="filterAssetCode" placeholder="Search Asset Code" oninput="applyFilters()" class="border p-2 rounded flex-1 bg-gray-800 text-white">
    <select id="filterCategory" onchange="applyFilters()" class="border p-2 rounded flex-1 bg-gray-800 text-white"></select>
    <select id="filterLocation" onchange="applyFilters()" class="border p-2 rounded flex-1 bg-gray-800 text-white"></select>
    <select id="filterManufacturer" onchange="applyFilters()" class="border p-2 rounded flex-1 bg-gray-800 text-white"></select>
    <select id="filterAmcVendor" onchange="applyFilters()" class="border p-2 rounded flex-1 bg-gray-800 text-white"></select>
    <select id="sortAssets" onchange="applySort()" class="border p-2 rounded flex-1 bg-gray-800 text-white">
      <option value="assetCode">Sort by Asset Code</option>
      <option value="assetName">Sort by Asset Name</option>
      <option value="installationDate">Sort by Installation Date</option>
    </select>
  </div>

  <!-- Export Buttons -->
  <div class="flex gap-2 mb-4">
    <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Export CSV</button>
    <button onclick="exportJSON()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">Export JSON</button>
  </div>

  <!-- Summary with mini charts -->
  <div id="summary" class="bg-gray-900 p-4 rounded mb-4 shadow flex flex-col md:flex-row md:justify-between md:items-center">
    <div>
      <p class="font-bold mb-2 text-cyan-400">Total Assets: <span id="totalAssets">0</span></p>
      <p class="mb-2">Assets by Block:</p>
      <ul id="blockList" class="list-disc ml-5 text-gray-300"></ul>
    </div>
    <div class="flex gap-2 mt-4 md:mt-0">
      <canvas class="bg-gray-800 rounded p-1" id="lineChart1" width="80" height="40"></canvas>
      <canvas class="bg-gray-800 rounded p-1" id="lineChart2" width="80" height="40"></canvas>
      <canvas class="bg-gray-800 rounded p-1" id="lineChart3" width="80" height="40"></canvas>
    </div>
  </div>

  <!-- Asset List -->
  <div id="assetList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

</div>
</body>
</html>
