<<<<<<< HEAD
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="logo.jpg">
<title>Energy Consumption Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background: linear-gradient(135deg,#0f172a,#1e293b);
  color: #e8ecff;
  font-family: 'Poppins', sans-serif;
}
.card {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  backdrop-filter: blur(12px);
  padding: 1.5rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.4);
}
.chart-container {
  position: relative;
  width: 100%;
  max-width: 800px;
  margin: auto;
}
.table-container { overflow-x:auto; }
.table th, .table td { padding:0.6rem 0.8rem; border-bottom:1px solid rgba(255,255,255,0.2); }
.table th { font-weight:600; }
.table td { color:#fff; }
.tab-buttons button {
  padding: 0.5rem 1rem;
  border-radius: 0.5rem 0.5rem 0 0;
  font-weight:600;
  border:none;
  margin-right:0.25rem;
  cursor:pointer;
  transition:0.3s;
}
.tab-buttons button.active { background: #2e7eff; color:white; }
.tab-content { display:none; animation:fadeIn 0.3s ease; }
.tab-content.active { display:block; }
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
</style>
</head>
<body class="p-6 min-h-screen">
  <!-- Back Button -->
<!-- Mobile Back Button -->
<div class="fixed back-btn-mobile z-50 md:hidden">
  <a href="dashboard.html" class="flex items-center gap-2 px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold shadow-lg text-sm">
    ⮐ Back
  </a>
</div>

  
</div>

<div class="max-w-7xl mx-auto space-y-6">
  <h1 class="text-3xl font-bold mb-4 text-center text-cyan-400">Energy Consumption Dashboard</h1>

  <!-- Tabs -->
  <div class="tab-buttons mb-4 text-center">
    <button class="active" data-tab="bescomTab">BESCOM - Electricity</button>
    <button data-tab="bwssbTab">BWSSB - Water</button>
    <button data-tab="generatorTab">Generators</button>
  </div>

  <!-- BESCOM Tab -->
  <div id="bescomTab" class="tab-content active space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card text-center">
        <p>Total kWh</p>
        <p id="totalBescom" class="text-2xl font-bold text-cyan-400 mt-2">0</p>
      </div>
      <div class="card text-center">
        <p>Total Spend (₹)</p>
        <p id="totalBescomSpend" class="text-2xl font-bold text-green-400 mt-2">0</p>
      </div>
      <div class="card text-center">
        <p>Peak Month</p>
        <p id="peakBescomMonth" class="text-2xl font-bold text-red-400 mt-2">-</p>
      </div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Monthly kWh Consumption</p>
      <div class="chart-container"><canvas id="bescomChart"></canvas></div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Monthly Bill</p>
      <div class="chart-container"><canvas id="bescomBillChart"></canvas></div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Efficiency</p>
      <div class="table-container">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Month</th>
              <th>Δ%</th>
              <th>Cost per kWh</th>
            </tr>
          </thead>
          <tbody id="bescomTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- BWSSB Tab -->
  <div id="bwssbTab" class="tab-content space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card text-center">
        <p>Total m³</p>
        <p id="totalBwssb" class="text-2xl font-bold text-yellow-400 mt-2">0</p>
      </div>
      <div class="card text-center">
        <p>Total Spend (₹)</p>
        <p id="totalBwssbSpend" class="text-2xl font-bold text-green-400 mt-2">0</p>
      </div>
      <div class="card text-center">
        <p>Peak Month</p>
        <p id="peakBwssbMonth" class="text-2xl font-bold text-red-400 mt-2">-</p>
      </div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Monthly m³ Consumption</p>
      <div class="chart-container"><canvas id="bwssbChart"></canvas></div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Monthly Bill</p>
      <div class="chart-container"><canvas id="bwssbBillChart"></canvas></div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Efficiency</p>
      <div class="table-container">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Month</th>
              <th>Δ%</th>
              <th>Cost per m³</th>
            </tr>
          </thead>
          <tbody id="bwssbTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Generators Tab -->
  <div id="generatorTab" class="tab-content space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card text-center">
        <p>Total Diesel Used (L)</p>
        <p id="totalDiesel" class="text-2xl font-bold text-green-400 mt-2">0</p>
      </div>
      <div class="card text-center">
        <p>Peak Month</p>
        <p id="peakDieselMonth" class="text-2xl font-bold text-red-400 mt-2">-</p>
      </div>
      <div class="card text-center">
        <p>Average Diesel per Generator (L)</p>
        <p id="avgDieselPerGen" class="text-2xl font-bold text-yellow-400 mt-2">0</p>
      </div>
    </div>

    <div class="card">
      <p class="mb-2 font-semibold">Monthly Diesel Consumption - Generator 1</p>
      <div class="chart-container"><canvas id="gen1Chart"></canvas></div>
    </div>

    <div class="card">
      <p class="mb-2 font-semibold">Monthly Diesel Consumption - Generator 2</p>
      <div class="chart-container"><canvas id="gen2Chart"></canvas></div>
    </div>

    <div class="card">
      <p class="mb-2 font-semibold">Diesel Efficiency (L/kWh)</p>
      <div class="chart-container"><canvas id="dieselEfficiencyChart"></canvas></div>
    </div>

    <div class="card">
      <p class="mb-2 font-semibold">Diesel Consumption Table</p>
      <div class="table-container">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Month</th>
              <th>Generator 1 (L)</th>
              <th>Generator 2 (L)</th>
              <th>Total Diesel (L)</th>
              <th>Efficiency L/kWh</th>
            </tr>
          </thead>
          <tbody id="genTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtdmsd0gWLPqwNpRI2lpiif_FuG-PTHjQ",
  authDomain: "ao-asset.firebaseapp.com",
  projectId: "ao-asset",
  storageBucket: "ao-asset.firebasestorage.app",
  messagingSenderId: "406786910363",
  appId: "1:406786910363:web:1d837738aab6c6b9d73e3e",
  measurementId: "G-4H7RF76176"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function fetchEnergyData(){
  const q = query(collection(db,'energyConsumption'), orderBy('monthYear','asc'));
  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc=>doc.data());
}

function processData(data){
  const months=[], bescom=[], bwssb=[], bescomBills=[], bwssbBills=[];
  const deltaBescom=[], deltaBwssb=[], costPerKwh=[], costPerM3=[];
  let prevBescom=0, prevBwssb=0, peakBescom=0, peakBwssb=0;
  let peakBescomMonth='-', peakBwssbMonth='-';
  let totalBescom=0, totalBwssb=0, totalBescomBill=0, totalBwssbBill=0;

  data.forEach(d=>{
    const month=d.monthYear; months.push(month);

    const bes = prevBescom ? (d.bescomReading - prevBescom) : d.bescomReading;
    const bw = prevBwssb ? (d.bwssbReading - prevBwssb) : d.bwssbReading;

    bescom.push(bes); bwssb.push(bw);
    bescomBills.push(d.bescomBill); bwssbBills.push(d.bwssbBill);

    totalBescom+=bes; totalBwssb+=bw;
    totalBescomBill+=d.bescomBill; totalBwssbBill+=d.bwssbBill;

    deltaBescom.push(prevBescom ? ((bes - (d.bescomReading-prevBescom))/prevBescom*100).toFixed(1) : 0);
    deltaBwssb.push(prevBwssb ? ((bw - (d.bwssbReading-prevBwssb))/prevBwssb*100).toFixed(1) : 0);

    costPerKwh.push(bes? (d.bescomBill/bes).toFixed(2):0);
    costPerM3.push(bw? (d.bwssbBill/bw).toFixed(2):0);

    if(bes>peakBescom){ peakBescom=bes; peakBescomMonth=month; }
    if(bw>peakBwssb){ peakBwssb=bw; peakBwssbMonth=month; }

    prevBescom=d.bescomReading; prevBwssb=d.bwssbReading;
  });

  return {months, bescom, bwssb, bescomBills, bwssbBills, deltaBescom, deltaBwssb, costPerKwh, costPerM3,
          totalBescom, totalBwssb, totalBescomBill, totalBwssbBill, peakBescomMonth, peakBwssbMonth};
}

function processGeneratorData(data){
  const months=[], gen1=[], gen2=[], totalDiesel=[], efficiency=[];
  let totalGen1=0, totalGen2=0, peakDiesel=0, peakMonth='-';

  data.forEach(d=>{
    months.push(d.monthYear);
    const g1 = d.generator1?.consumption || 0;
    const g2 = d.generator2?.consumption || 0;
    gen1.push(g1);
    gen2.push(g2);
    const total = g1+g2;
    totalDiesel.push(total);
    totalGen1 += g1;
    totalGen2 += g2;
    if(total > peakDiesel){ peakDiesel=total; peakMonth=d.monthYear; }
    // Efficiency L/kWh
    const electricityUsed = d.bescomReading - (d.prevBescomReading || 0);
    efficiency.push(electricityUsed>0 ? (total/electricityUsed).toFixed(2) : 0);
  });

  const avgPerGen = ((totalGen1+totalGen2)/ (data.length*2)).toFixed(2);
  return {months, gen1, gen2, totalDiesel, efficiency, totalGen1, totalGen2, avgPerGen, peakDieselMonth:peakMonth};
}

function renderCharts(processed){
  new Chart(document.getElementById('bescomChart'), {type:'line', data:{labels:processed.months,datasets:[{label:'kWh',data:processed.bescom,borderColor:'#06b6d4',fill:true,backgroundColor:'rgba(6,182,212,0.1)',tension:0.3}]}, options:{responsive:true}});
  new Chart(document.getElementById('bescomBillChart'), {type:'bar', data:{labels:processed.months,datasets:[{label:'₹ Bill',data:processed.bescomBills,backgroundColor:'#4ade80'}]}, options:{responsive:true}});
  new Chart(document.getElementById('bwssbChart'), {type:'line', data:{labels:processed.months,datasets:[{label:'m³',data:processed.bwssb,borderColor:'#f97316',fill:true,backgroundColor:'rgba(249,115,22,0.1)',tension:0.3}]}, options:{responsive:true}});
  new Chart(document.getElementById('bwssbBillChart'), {type:'bar', data:{labels:processed.months,datasets:[{label:'₹ Bill',data:processed.bwssbBills,backgroundColor:'#facc15'}]}, options:{responsive:true}});
}

function renderTables(processed){
  const bescomT=document.getElementById('bescomTable');
  const bwssbT=document.getElementById('bwssbTable');
  bescomT.innerHTML=''; bwssbT.innerHTML='';

  processed.months.forEach((m,i)=>{
    bescomT.innerHTML+=`<tr><td>${m}</td><td class="${processed.deltaBescom[i]<0?'text-green-400':'text-red-400'}">${processed.deltaBescom[i]}%</td><td>₹${processed.costPerKwh[i]}</td></tr>`;
    bwssbT.innerHTML+=`<tr><td>${m}</td><td class="${processed.deltaBwssb[i]<0?'text-green-400':'text-red-400'}">${processed.deltaBwssb[i]}%</td><td>₹${processed.costPerM3[i]}</td></tr>`;
  });

  document.getElementById('totalBescom').textContent=processed.totalBescom+' kWh';
  document.getElementById('totalBescomSpend').textContent='₹'+processed.totalBescomBill;
  document.getElementById('peakBescomMonth').textContent=processed.peakBescomMonth;

  document.getElementById('totalBwssb').textContent=processed.totalBwssb+' m³';
  document.getElementById('totalBwssbSpend').textContent='₹'+processed.totalBwssbBill;
  document.getElementById('peakBwssbMonth').textContent=processed.peakBwssbMonth;
}

function renderGeneratorCharts(processed){
  new Chart(document.getElementById('gen1Chart'), {type:'line', data:{labels:processed.months,datasets:[{label:'Generator 1 Diesel (L)',data:processed.gen1,borderColor:'#4ade80',fill:true,backgroundColor:'rgba(74,222,128,0.1)',tension:0.3}]}, options:{responsive:true}});
  new Chart(document.getElementById('gen2Chart'), {type:'line', data:{labels:processed.months,datasets:[{label:'Generator 2 Diesel (L)',data:processed.gen2,borderColor:'#facc15',fill:true,backgroundColor:'rgba(250,204,21,0.1)',tension:0.3}]}, options:{responsive:true}});
  new Chart(document.getElementById('dieselEfficiencyChart'), {type:'line', data:{labels:processed.months,datasets:[{label:'Diesel Efficiency L/kWh',data:processed.efficiency,borderColor:'#06b6d4',fill:true,backgroundColor:'rgba(6,182,212,0.1)',tension:0.3}]}, options:{responsive:true}});

  const tbody = document.getElementById('genTable'); tbody.innerHTML='';
  processed.months.forEach((m,i)=>{
    tbody.innerHTML+=`<tr><td>${m}</td><td>${processed.gen1[i]}</td><td>${processed.gen2[i]}</td><td>${processed.totalDiesel[i]}</td><td>${processed.efficiency[i]}</td></tr>`;
  });

  document.getElementById('totalDiesel').textContent=processed.totalGen1+processed.totalGen2;
  document.getElementById('avgDieselPerGen').textContent=processed.avgPerGen;
  document.getElementById('peakDieselMonth').textContent=processed.peakDieselMonth;
}

// Tabs
document.querySelectorAll('.tab-buttons button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-buttons button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
  });
});

// Initialize
async function init(){
  const raw = await fetchEnergyData();
  // Add previous month readings for diesel efficiency
  raw.forEach((d,i)=>{ d.prevBescomReading = i>0 ? raw[i-1].bescomReading : 0; });
  const processed = processData(raw);
  renderCharts(processed);
  renderTables(processed);

  const genProcessed = processGeneratorData(raw);
  renderGeneratorCharts(genProcessed);
}

init();
</script>
<p class="text-xs text-textsoft mt-6">© 2025 AO Asset Systems. All rights reserved.</p>
</body>
</html>
=======
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="logo.jpg">
<title>Energy Consumption Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background: linear-gradient(135deg,#0f172a,#1e293b);
  color: #e8ecff;
  font-family: 'Poppins', sans-serif;
}
.card {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  backdrop-filter: blur(12px);
  padding: 1.5rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.4);
}
.chart-container {
  position: relative;
  width: 100%;
  max-width: 800px;
  margin: auto;
}
.table-container { overflow-x:auto; }
.table th, .table td { padding:0.6rem 0.8rem; border-bottom:1px solid rgba(255,255,255,0.2); }
.table th { font-weight:600; }
.table td { color:#fff; }
.tab-buttons button {
  padding: 0.5rem 1rem;
  border-radius: 0.5rem 0.5rem 0 0;
  font-weight:600;
  border:none;
  margin-right:0.25rem;
  cursor:pointer;
  transition:0.3s;
}
.tab-buttons button.active { background: #2e7eff; color:white; }
.tab-content { display:none; animation:fadeIn 0.3s ease; }
.tab-content.active { display:block; }
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
</style>
</head>
<body class="p-6 min-h-screen">
  <!-- Back Button -->
<!-- Mobile Back Button -->
<div class="fixed back-btn-mobile z-50 md:hidden">
  <a href="dashboard.html" class="flex items-center gap-2 px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold shadow-lg text-sm">
    ⮐ Back
  </a>
</div>

  
</div>

<div class="max-w-7xl mx-auto space-y-6">
  <h1 class="text-3xl font-bold mb-4 text-center text-cyan-400">Energy Consumption Dashboard</h1>

  <!-- Tabs -->
  <div class="tab-buttons mb-4 text-center">
    <button class="active" data-tab="bescomTab">BESCOM - Electricity</button>
    <button data-tab="bwssbTab">BWSSB - Water</button>
    <button data-tab="generatorTab">Generators</button>
  </div>

  <!-- BESCOM Tab -->
  <div id="bescomTab" class="tab-content active space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card text-center">
        <p>Total kWh</p>
        <p id="totalBescom" class="text-2xl font-bold text-cyan-400 mt-2">0</p>
      </div>
      <div class="card text-center">
        <p>Total Spend (₹)</p>
        <p id="totalBescomSpend" class="text-2xl font-bold text-green-400 mt-2">0</p>
      </div>
      <div class="card text-center">
        <p>Peak Month</p>
        <p id="peakBescomMonth" class="text-2xl font-bold text-red-400 mt-2">-</p>
      </div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Monthly kWh Consumption</p>
      <div class="chart-container"><canvas id="bescomChart"></canvas></div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Monthly Bill</p>
      <div class="chart-container"><canvas id="bescomBillChart"></canvas></div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Efficiency</p>
      <div class="table-container">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Month</th>
              <th>Δ%</th>
              <th>Cost per kWh</th>
            </tr>
          </thead>
          <tbody id="bescomTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- BWSSB Tab -->
  <div id="bwssbTab" class="tab-content space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card text-center">
        <p>Total m³</p>
        <p id="totalBwssb" class="text-2xl font-bold text-yellow-400 mt-2">0</p>
      </div>
      <div class="card text-center">
        <p>Total Spend (₹)</p>
        <p id="totalBwssbSpend" class="text-2xl font-bold text-green-400 mt-2">0</p>
      </div>
      <div class="card text-center">
        <p>Peak Month</p>
        <p id="peakBwssbMonth" class="text-2xl font-bold text-red-400 mt-2">-</p>
      </div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Monthly m³ Consumption</p>
      <div class="chart-container"><canvas id="bwssbChart"></canvas></div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Monthly Bill</p>
      <div class="chart-container"><canvas id="bwssbBillChart"></canvas></div>
    </div>
    <div class="card">
      <p class="mb-2 font-semibold">Efficiency</p>
      <div class="table-container">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Month</th>
              <th>Δ%</th>
              <th>Cost per m³</th>
            </tr>
          </thead>
          <tbody id="bwssbTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Generators Tab -->
  <div id="generatorTab" class="tab-content space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card text-center">
        <p>Total Diesel Used (L)</p>
        <p id="totalDiesel" class="text-2xl font-bold text-green-400 mt-2">0</p>
      </div>
      <div class="card text-center">
        <p>Peak Month</p>
        <p id="peakDieselMonth" class="text-2xl font-bold text-red-400 mt-2">-</p>
      </div>
      <div class="card text-center">
        <p>Average Diesel per Generator (L)</p>
        <p id="avgDieselPerGen" class="text-2xl font-bold text-yellow-400 mt-2">0</p>
      </div>
    </div>

    <div class="card">
      <p class="mb-2 font-semibold">Monthly Diesel Consumption - Generator 1</p>
      <div class="chart-container"><canvas id="gen1Chart"></canvas></div>
    </div>

    <div class="card">
      <p class="mb-2 font-semibold">Monthly Diesel Consumption - Generator 2</p>
      <div class="chart-container"><canvas id="gen2Chart"></canvas></div>
    </div>

    <div class="card">
      <p class="mb-2 font-semibold">Diesel Efficiency (L/kWh)</p>
      <div class="chart-container"><canvas id="dieselEfficiencyChart"></canvas></div>
    </div>

    <div class="card">
      <p class="mb-2 font-semibold">Diesel Consumption Table</p>
      <div class="table-container">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Month</th>
              <th>Generator 1 (L)</th>
              <th>Generator 2 (L)</th>
              <th>Total Diesel (L)</th>
              <th>Efficiency L/kWh</th>
            </tr>
          </thead>
          <tbody id="genTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtdmsd0gWLPqwNpRI2lpiif_FuG-PTHjQ",
  authDomain: "ao-asset.firebaseapp.com",
  projectId: "ao-asset",
  storageBucket: "ao-asset.firebasestorage.app",
  messagingSenderId: "406786910363",
  appId: "1:406786910363:web:1d837738aab6c6b9d73e3e",
  measurementId: "G-4H7RF76176"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function fetchEnergyData(){
  const q = query(collection(db,'energyConsumption'), orderBy('monthYear','asc'));
  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc=>doc.data());
}

function processData(data){
  const months=[], bescom=[], bwssb=[], bescomBills=[], bwssbBills=[];
  const deltaBescom=[], deltaBwssb=[], costPerKwh=[], costPerM3=[];
  let prevBescom=0, prevBwssb=0, peakBescom=0, peakBwssb=0;
  let peakBescomMonth='-', peakBwssbMonth='-';
  let totalBescom=0, totalBwssb=0, totalBescomBill=0, totalBwssbBill=0;

  data.forEach(d=>{
    const month=d.monthYear; months.push(month);

    const bes = prevBescom ? (d.bescomReading - prevBescom) : d.bescomReading;
    const bw = prevBwssb ? (d.bwssbReading - prevBwssb) : d.bwssbReading;

    bescom.push(bes); bwssb.push(bw);
    bescomBills.push(d.bescomBill); bwssbBills.push(d.bwssbBill);

    totalBescom+=bes; totalBwssb+=bw;
    totalBescomBill+=d.bescomBill; totalBwssbBill+=d.bwssbBill;

    deltaBescom.push(prevBescom ? ((bes - (d.bescomReading-prevBescom))/prevBescom*100).toFixed(1) : 0);
    deltaBwssb.push(prevBwssb ? ((bw - (d.bwssbReading-prevBwssb))/prevBwssb*100).toFixed(1) : 0);

    costPerKwh.push(bes? (d.bescomBill/bes).toFixed(2):0);
    costPerM3.push(bw? (d.bwssbBill/bw).toFixed(2):0);

    if(bes>peakBescom){ peakBescom=bes; peakBescomMonth=month; }
    if(bw>peakBwssb){ peakBwssb=bw; peakBwssbMonth=month; }

    prevBescom=d.bescomReading; prevBwssb=d.bwssbReading;
  });

  return {months, bescom, bwssb, bescomBills, bwssbBills, deltaBescom, deltaBwssb, costPerKwh, costPerM3,
          totalBescom, totalBwssb, totalBescomBill, totalBwssbBill, peakBescomMonth, peakBwssbMonth};
}

function processGeneratorData(data){
  const months=[], gen1=[], gen2=[], totalDiesel=[], efficiency=[];
  let totalGen1=0, totalGen2=0, peakDiesel=0, peakMonth='-';

  data.forEach(d=>{
    months.push(d.monthYear);
    const g1 = d.generator1?.consumption || 0;
    const g2 = d.generator2?.consumption || 0;
    gen1.push(g1);
    gen2.push(g2);
    const total = g1+g2;
    totalDiesel.push(total);
    totalGen1 += g1;
    totalGen2 += g2;
    if(total > peakDiesel){ peakDiesel=total; peakMonth=d.monthYear; }
    // Efficiency L/kWh
    const electricityUsed = d.bescomReading - (d.prevBescomReading || 0);
    efficiency.push(electricityUsed>0 ? (total/electricityUsed).toFixed(2) : 0);
  });

  const avgPerGen = ((totalGen1+totalGen2)/ (data.length*2)).toFixed(2);
  return {months, gen1, gen2, totalDiesel, efficiency, totalGen1, totalGen2, avgPerGen, peakDieselMonth:peakMonth};
}

function renderCharts(processed){
  new Chart(document.getElementById('bescomChart'), {type:'line', data:{labels:processed.months,datasets:[{label:'kWh',data:processed.bescom,borderColor:'#06b6d4',fill:true,backgroundColor:'rgba(6,182,212,0.1)',tension:0.3}]}, options:{responsive:true}});
  new Chart(document.getElementById('bescomBillChart'), {type:'bar', data:{labels:processed.months,datasets:[{label:'₹ Bill',data:processed.bescomBills,backgroundColor:'#4ade80'}]}, options:{responsive:true}});
  new Chart(document.getElementById('bwssbChart'), {type:'line', data:{labels:processed.months,datasets:[{label:'m³',data:processed.bwssb,borderColor:'#f97316',fill:true,backgroundColor:'rgba(249,115,22,0.1)',tension:0.3}]}, options:{responsive:true}});
  new Chart(document.getElementById('bwssbBillChart'), {type:'bar', data:{labels:processed.months,datasets:[{label:'₹ Bill',data:processed.bwssbBills,backgroundColor:'#facc15'}]}, options:{responsive:true}});
}

function renderTables(processed){
  const bescomT=document.getElementById('bescomTable');
  const bwssbT=document.getElementById('bwssbTable');
  bescomT.innerHTML=''; bwssbT.innerHTML='';

  processed.months.forEach((m,i)=>{
    bescomT.innerHTML+=`<tr><td>${m}</td><td class="${processed.deltaBescom[i]<0?'text-green-400':'text-red-400'}">${processed.deltaBescom[i]}%</td><td>₹${processed.costPerKwh[i]}</td></tr>`;
    bwssbT.innerHTML+=`<tr><td>${m}</td><td class="${processed.deltaBwssb[i]<0?'text-green-400':'text-red-400'}">${processed.deltaBwssb[i]}%</td><td>₹${processed.costPerM3[i]}</td></tr>`;
  });

  document.getElementById('totalBescom').textContent=processed.totalBescom+' kWh';
  document.getElementById('totalBescomSpend').textContent='₹'+processed.totalBescomBill;
  document.getElementById('peakBescomMonth').textContent=processed.peakBescomMonth;

  document.getElementById('totalBwssb').textContent=processed.totalBwssb+' m³';
  document.getElementById('totalBwssbSpend').textContent='₹'+processed.totalBwssbBill;
  document.getElementById('peakBwssbMonth').textContent=processed.peakBwssbMonth;
}

function renderGeneratorCharts(processed){
  new Chart(document.getElementById('gen1Chart'), {type:'line', data:{labels:processed.months,datasets:[{label:'Generator 1 Diesel (L)',data:processed.gen1,borderColor:'#4ade80',fill:true,backgroundColor:'rgba(74,222,128,0.1)',tension:0.3}]}, options:{responsive:true}});
  new Chart(document.getElementById('gen2Chart'), {type:'line', data:{labels:processed.months,datasets:[{label:'Generator 2 Diesel (L)',data:processed.gen2,borderColor:'#facc15',fill:true,backgroundColor:'rgba(250,204,21,0.1)',tension:0.3}]}, options:{responsive:true}});
  new Chart(document.getElementById('dieselEfficiencyChart'), {type:'line', data:{labels:processed.months,datasets:[{label:'Diesel Efficiency L/kWh',data:processed.efficiency,borderColor:'#06b6d4',fill:true,backgroundColor:'rgba(6,182,212,0.1)',tension:0.3}]}, options:{responsive:true}});

  const tbody = document.getElementById('genTable'); tbody.innerHTML='';
  processed.months.forEach((m,i)=>{
    tbody.innerHTML+=`<tr><td>${m}</td><td>${processed.gen1[i]}</td><td>${processed.gen2[i]}</td><td>${processed.totalDiesel[i]}</td><td>${processed.efficiency[i]}</td></tr>`;
  });

  document.getElementById('totalDiesel').textContent=processed.totalGen1+processed.totalGen2;
  document.getElementById('avgDieselPerGen').textContent=processed.avgPerGen;
  document.getElementById('peakDieselMonth').textContent=processed.peakDieselMonth;
}

// Tabs
document.querySelectorAll('.tab-buttons button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-buttons button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
  });
});

// Initialize
async function init(){
  const raw = await fetchEnergyData();
  // Add previous month readings for diesel efficiency
  raw.forEach((d,i)=>{ d.prevBescomReading = i>0 ? raw[i-1].bescomReading : 0; });
  const processed = processData(raw);
  renderCharts(processed);
  renderTables(processed);

  const genProcessed = processGeneratorData(raw);
  renderGeneratorCharts(genProcessed);
}

init();
</script>
<p class="text-xs text-textsoft mt-6">© 2025 AO Asset Systems. All rights reserved.</p>
</body>
</html>
>>>>>>> 201bf38f13aff9dab04413e9d5e2b80a91e9814b
