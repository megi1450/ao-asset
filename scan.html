<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Scanner</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCtdmsd0gWLPqwNpRI2lpiif_FuG-PTHjQ",
  authDomain: "ao-asset.firebaseapp.com",
  projectId: "ao-asset",
  storageBucket: "ao-asset.firebasestorage.app",
  messagingSenderId: "406786910363",
  appId: "1:406786910363:web:1d837738aab6c6b9d73e3e",
  measurementId: "G-4H7RF76176"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const assetCodeParam = params.get('assetCode');

const container = document.getElementById('mainContainer');
const scanContainer = document.getElementById('scanContainer');
const video = document.getElementById('video');
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
const startScanBtn = document.getElementById('startScan');
const scanMessage = document.getElementById('scanMessage');
const overlayLine = document.getElementById('overlayLine');

async function fetchAsset(code){
    try{
        const q = query(collection(db,'assets'), where('assetCode','==',code));
        const snapshot = await getDocs(q);
        if(snapshot.empty){
            container.innerHTML = `<p class="text-red-400 text-center text-lg mt-10">No asset found for code: <b>${code}</b></p>`;
            return;
        }
        const asset = snapshot.docs[0].data();
        displayAsset(asset);
    } catch(e){
        console.error(e);
        container.innerHTML = `<p class="text-red-400 text-center mt-10">Failed to fetch asset data.</p>`;
    }
}

function displayAsset(a){
    container.innerHTML = `
    <div class="max-w-lg mx-auto mt-10 p-6 bg-gray-800 rounded-xl shadow-2xl text-white space-y-3 animate-fadeIn">
      <h2 class="text-2xl font-bold text-cyan-400">${a.assetName} (${a.assetCode})</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <p><strong>Category:</strong> ${a.category}</p>
        <p><strong>Location:</strong> ${a.location} (${a.locationShort||''})</p>
        <p><strong>Manufacturer:</strong> ${a.manufacturer}</p>
        <p><strong>Model:</strong> ${a.model || 'N/D'}</p>
        <p><strong>Installed:</strong> ${a.installationDate || 'N/D'}</p>
        <p><strong>AMC Vendor:</strong> ${a.amcVendor || 'N/D'}</p>
        <p><strong>AMC Start:</strong> ${a.amcStart || 'N/D'}</p>
        <p><strong>AMC End:</strong> ${a.amcEnd || 'N/D'}</p>
        <p class="col-span-2"><strong>Remarks:</strong> ${a.remark || ''}</p>
      </div>
      <button onclick="startAgain()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded mt-4 w-full">Scan Again</button>
    </div>
    `;
}

function startAgain(){
    container.innerHTML = '';
    scanContainer.classList.remove('hidden');
    startCamera();
}

// QR Scan logic
async function startCamera(){
    try{
        scanMessage.textContent = "Initializing camera...";
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' } });
        video.srcObject = stream;
        video.setAttribute('playsinline',true);
        await video.play();
        scanMessage.textContent = "Scanning for QR code...";
        scanFrame();
        animateOverlay();
    } catch(e){
        console.error(e);
        container.innerHTML = `<p class="text-red-400 text-center mt-10">Camera access denied or not available.</p>`;
    }
}

async function scanFrame(){
    if(video.readyState !== video.HAVE_ENOUGH_DATA){
        requestAnimationFrame(scanFrame);
        return;
    }
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);

    const code = jsQR(imageData.data, imageData.width, imageData.height);

    if(code){
        scanMessage.textContent = "QR detected!";
        video.srcObject.getTracks().forEach(track=>track.stop());
        scanContainer.classList.add('hidden');

        // If QR is URL, redirect
        try {
            const url = new URL(code.data);
            window.location.href = url.href;
            return;
        } catch(e){
            // Not URL, treat as assetCode
        }
        fetchAsset(code.data);
    } else {
        requestAnimationFrame(scanFrame);
    }
}

// Scanner overlay animation
function animateOverlay(){
    let pos = 0, dir = 1;
    const height = overlayLine.parentElement.clientHeight;
    function frame(){
        pos += dir*2;
        if(pos>=height-4 || pos<=0) dir*=-1;
        overlayLine.style.top = pos+"px";
        requestAnimationFrame(frame);
    }
    frame();
}

startScanBtn.onclick = () => {
    scanContainer.classList.remove('hidden');
    container.innerHTML = '';
    startCamera();
};

// Auto-fetch if URL has assetCode
if(assetCodeParam){
    fetchAsset(assetCodeParam);
} else {
    scanContainer.classList.remove('hidden');
}
</script>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<style>
body { background: linear-gradient(135deg,#0f172a,#1e293b); min-height:100vh; }
button { transition: all 0.2s; }
button:hover { transform: scale(1.05); }
#scanContainer { position: relative; max-width:400px; width:100%; }
#video { border-radius:1rem; }
#overlay { position:absolute; top:0; left:0; width:100%; height:100%; border:3px dashed cyan; border-radius:1rem; pointer-events:none; box-sizing:border-box; }
#overlayLine { position:absolute; left:0; width:100%; height:4px; background:cyan; pointer-events:none; }
.animate-fadeIn { animation: fadeIn 0.5s ease forwards; }
@keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
</style>
</head>
<body class="text-white flex flex-col items-center p-4">
    <h1 class="text-3xl font-bold mb-6 text-cyan-400 text-center">Asset Scanner</h1>

    <div id="scanContainer" class="flex flex-col items-center gap-4 hidden">
        <div class="relative w-full">
            <video id="video" class="w-full max-w-md rounded shadow-lg border-2 border-cyan-500"></video>
            <div id="overlay"></div>
            <div id="overlayLine"></div>
        </div>
        <p id="scanMessage" class="text-gray-300 text-sm text-center">Align QR code within the scanner frame</p>
        <button id="startScan" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded mt-2">Start Camera Scan</button>
    </div>

    <div id="mainContainer" class="w-full"></div>
</body>
</html>
