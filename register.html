<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="logo.jpg">
  <title>Asset Registration</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCtdmsd0gWLPqwNpRI2lpiif_FuG-PTHjQ",
  authDomain: "ao-asset.firebaseapp.com",
  projectId: "ao-asset",
  storageBucket: "ao-asset.firebasestorage.app",
  messagingSenderId: "406786910363",
  appId: "1:406786910363:web:1d837738aab6c6b9d73e3e",
  measurementId: "G-4H7RF76176"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let locations = [];
let manufacturers = [];
let assetNames = [];
let categories = [];
let models = [];
let remarksList = [];
let dataLoaded = {
  assetNames: false,
  categories: false,
  manufacturers: false,
  models: false,
  remarks: false,
  locations: false
};

// Helper log function
function log(msg){ 
  console.log(`[AssetReg] ${msg}`); 
}

// Fetch dropdown options
async function fetchOptions(subcollection) {
  const colRef = collection(db, 'dropdowns', 'options', subcollection);
  const snapshot = await getDocs(colRef);
  const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  log(`Fetched ${data.length} options for ${subcollection}`);
  return data;
}

// Populate dropdowns
async function populateDropdown(id, subcollection) {
  let options = await fetchOptions(subcollection);

  switch (subcollection) {
    case 'locations':
      locations = options;
        dataLoaded.locations = true;
      return;
    case 'manufacturers':
      manufacturers = options;
        dataLoaded.manufacturers = true;
      return;
    case 'assetNames':
      assetNames = options;
        dataLoaded.assetNames = true;
      return;
    case 'categories':
      categories = options;
      dataLoaded.categories = true;
      return;
    case 'models':
      models = options;
      dataLoaded.models = true;
      return;
    case 'remarks':
      remarksList = options;
      dataLoaded.remarks = true;
      return;
  }
}
function setupSearchableDropdown(inputId, dropdownId, dataList, onSelect) {
  const input = document.getElementById(inputId);
  const dropdown = document.getElementById(dropdownId);

function filterList() {

  // DATA NOT READY YET
  if (!dataList || dataList.length === 0) {
    dropdown.innerHTML = `
      <li class="px-2 py-1 text-gray-400 italic">
        Loading data…
      </li>
    `;
    dropdown.classList.remove('hidden');
    return;
  }

  const value = input.value.toLowerCase().trim();

  const filtered = dataList.filter(item =>
    item.name.toLowerCase().includes(value)
  );

  dropdown.innerHTML = "";

  if (filtered.length === 0) {
    dropdown.innerHTML = `
      <li class="px-2 py-1 text-gray-400 italic">
        No matches found
      </li>
    `;
  } else {
    filtered.forEach(item => {
      const li = document.createElement('li');
      li.className = "px-2 py-1 hover:bg-blue-600 cursor-pointer";
      li.textContent = item.name;
li.classList.add('break-words');


      li.onclick = () => {
        input.value = item.name;
        input.dataset.selectedValue = JSON.stringify(item);
        dropdown.classList.add('hidden');
        onSelect?.(item);
      };

      dropdown.appendChild(li);
    });
  }

  dropdown.classList.remove('hidden');
}


  input.addEventListener('input', filterList);
  input.addEventListener('focus', filterList);

  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add('hidden');
      if (!dataList.find(d => d.name === input.value)) {
        input.value = "";
        input.dataset.selectedValue = "";
        onSelect?.(null);
      }
    }
  });
}


function setupManufacturerDropdown() {
  const input = document.getElementById('manufacturerInput');
  const dropdown = document.getElementById('manufacturerDropdown');

  function filterManufacturers() {
    const value = input.value.toLowerCase().trim();

    const filtered = manufacturers.filter(m =>
      m.name.toLowerCase().includes(value)
    );

    dropdown.innerHTML = "";
    filtered.forEach(m => {
      const li = document.createElement('li');
      li.className = "px-2 py-1 hover:bg-blue-600 cursor-pointer";
      li.textContent = m.name;

      li.onclick = () => {
        input.value = m.name;
        input.dataset.selectedValue = JSON.stringify(m);
        dropdown.classList.add('hidden');
      };

      dropdown.appendChild(li);
    });

    dropdown.classList.remove('hidden');
  }

  input.addEventListener('input', filterManufacturers);
  input.addEventListener('focus', filterManufacturers);

  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add('hidden');
      if (!manufacturers.find(m => m.name === input.value)) {
        input.value = "";
        input.dataset.selectedValue = "";
      }
    }
  });
}


// Add new dropdown item
async function addNewItem(subcollection, dropdownId) {
  let newName = prompt(`Enter new ${subcollection === 'assetNames' ? 'Asset Name' : subcollection}:`);
  if(!newName) return;
  newName = newName.trim();
  const existingOptions = await fetchOptions(subcollection);

  if(existingOptions.find(opt => opt.name.toLowerCase() === newName.toLowerCase())){
    alert(`${newName} already exists!`);
    log(`Attempted to add duplicate ${newName}`);
    return;
  }

  let newObj = { name: newName };

  if(subcollection === "assetNames"){
    let words = newName.split(/\s+/);
    let short = words.map(w => w[0].toUpperCase()).join('');
    if(short.length < 3){
      let extra = words[0].slice(1, 4 - short.length).toUpperCase();
      short += extra;
    } else if(short.length > 3){
      short = short.slice(0,3);
    }

    let existingShorts = existingOptions.map(o => o.short).filter(s => s);
    let count = 1;
    let originalShort = short;
    while(existingShorts.includes(short)){
      short = originalShort + count;
      count++;
    }
    newObj.short = short;
  }

  await addDoc(collection(db, 'dropdowns', 'options', subcollection), newObj);
  alert(`${newName} added${newObj.short ? ` with short code ${newObj.short}` : ''}`);
  log(`New item added in ${subcollection}: ${newName}`);
  await populateDropdown(dropdownId, subcollection);
}

// Generate asset code
async function generateAssetCode(assetShort, locationShort){
  const q = query(collection(db, 'assets'), where('assetShort','==',assetShort));
  const snapshot = await getDocs(q);
  const count = snapshot.size + 1;
  const code = `AO-${assetShort}-${locationShort}-${count.toString().padStart(3,'0')}`;
  log(`Generated Asset Code: ${code}`);
  return code;
}

async function updateGeneratedCode() {
  const assetSel =
    document.getElementById('assetNameInput').dataset.selectedValue
      ? JSON.parse(document.getElementById('assetNameInput').dataset.selectedValue)
      : null;

  const locationSel =
    document.getElementById('locationInput').dataset.selectedValue
      ? JSON.parse(document.getElementById('locationInput').dataset.selectedValue)
      : null;

  if (!assetSel || !locationSel) {
    document.getElementById('generatedCode').textContent = "";
    return;
  }

  const code = await generateAssetCode(assetSel.short, locationSel.short);
  document.getElementById('generatedCode').textContent = `Generated Asset Code: ${code}`;
}


// Submit asset
async function submitAsset(){
  log("Submitting asset...");
  document.getElementById('loadingOverlay').style.display = 'flex';

  const assetSel =
  document.getElementById('assetNameInput').dataset.selectedValue
    ? JSON.parse(document.getElementById('assetNameInput').dataset.selectedValue)
    : null;

const categorySel =
  document.getElementById('categoryInput').dataset.selectedValue
    ? JSON.parse(document.getElementById('categoryInput').dataset.selectedValue)
    : null;

const modelSel =
  document.getElementById('modelInput').dataset.selectedValue
    ? JSON.parse(document.getElementById('modelInput').dataset.selectedValue)
    : null;

const remarkSel =
  document.getElementById('remarksInput').dataset.selectedValue
    ? JSON.parse(document.getElementById('remarksInput').dataset.selectedValue)
    : null;

  const manufacturerSel =
  document.getElementById('manufacturerInput').dataset.selectedValue
    ? JSON.parse(document.getElementById('manufacturerInput').dataset.selectedValue)
    : null;

  
  const installationDate = document.getElementById('installationDate').value;
  const locationSel = document.getElementById('locationInput').dataset.selectedValue ? JSON.parse(document.getElementById('locationInput').dataset.selectedValue) : null;
  const amcVendor = document.getElementById('amcVendor').value;
  
  const amcStart = document.getElementById('amcStart').value;
  const amcEnd = document.getElementById('amcEnd').value;

  if(!assetSel || !categorySel || !manufacturerSel || !modelSel || !installationDate || !locationSel || !amcVendor || !remarkSel){
    alert("Please fill all mandatory fields.");
    document.getElementById('loadingOverlay').style.display = 'none';
    log("Submission cancelled: mandatory fields missing");
    return;
  }

  const amcStartVal = amcStart || "N/A";
  const amcEndVal = amcEnd || "N/A";

  const assetCode = await generateAssetCode(assetSel.short, locationSel.short);

  await addDoc(collection(db, 'assets'), {
    assetCode,
    assetName: assetSel.name,
    assetShort: assetSel.short,
    category: categorySel.name,
    manufacturer: manufacturerSel.name,
    model: modelSel.name,
    installationDate,
    location: locationSel.name,
    locationShort: locationSel.short,
    amcVendor,
    remark: remarkSel.name,
    amcStart: amcStartVal,
    amcEnd: amcEndVal
  });

  log("Asset successfully added to database");

  alert(`Asset Registered! Code: ${assetCode}`);
  document.getElementById('assetForm').reset();
  document.getElementById('generatedCode').textContent = "";
  document.getElementById('locationDropdown').innerHTML = "";
  document.getElementById('locationInput').dataset.selectedValue = "";
  document.getElementById('loadingOverlay').style.display = 'none';
}

// Location dropdown filter
function setupLocationDropdown(){
  const input = document.getElementById('locationInput');
  const dropdown = document.getElementById('locationDropdown');

  function filterLocations(){
    const value = input.value.toLowerCase().trim();
    const parts = value.split(/\s+/);
    const filtered = locations.filter(loc => {
      const locStr = loc.name.toLowerCase().replace(/\s+/g, '');
      return parts.every(p => locStr.includes(p.replace(/\s+/g, '')));
    });

    dropdown.innerHTML = "";
    filtered.forEach(loc => {
      const li = document.createElement('li');
      li.className = "px-2 py-1 hover:bg-blue-600 cursor-pointer";

      let displayName = loc.name;
      parts.forEach(p => {
        const regex = new RegExp(`(${p})`, 'i');
        displayName = displayName.replace(regex, '<span class="bg-yellow-400 text-black">$1</span>');
      });
      li.innerHTML = displayName;

      li.onclick = () => {
        input.value = loc.name;
        input.dataset.selectedValue = JSON.stringify(loc);
        dropdown.classList.add('hidden');
        updateGeneratedCode();
        log(`Location selected: ${loc.name}`);
      };
      dropdown.appendChild(li);
    });

    dropdown.classList.remove('hidden');
  }

  input.addEventListener('input', filterLocations);
  input.addEventListener('focus', filterLocations);

  document.addEventListener('click', (e)=>{
    if(!input.contains(e.target) && !dropdown.contains(e.target)){
      dropdown.classList.add('hidden');
      if(!locations.find(loc => loc.name === input.value)){
        input.value = "";
        input.dataset.selectedValue = "";
        updateGeneratedCode();
      }
    }
  });
}

// On page load
window.addEventListener('DOMContentLoaded', async () => {

  document.querySelectorAll(
  '#assetNameInput, #categoryInput, #manufacturerInput, #modelInput, #remarksInput'
).forEach(input => {
  input.disabled = true;
  input.placeholder = "Loading…";
});

  // LOAD DATA (ONCE)
  await populateDropdown(null,'assetNames');
  await populateDropdown(null,'categories');
  await populateDropdown(null,'manufacturers');
  await populateDropdown(null,'models');
  await populateDropdown(null,'remarks');
  await populateDropdown(null,'locations');

  // SEARCH DROPDOWNS (ALL SAME SYSTEM)
  setupSearchableDropdown(
    'assetNameInput',
    'assetNameDropdown',
    assetNames,
    updateGeneratedCode
  );

  setupSearchableDropdown(
    'categoryInput',
    'categoryDropdown',
    categories
  );

  setupSearchableDropdown(
    'manufacturerInput',
    'manufacturerDropdown',
    manufacturers
  );

  setupSearchableDropdown(
    'modelInput',
    'modelDropdown',
    models
  );

  setupSearchableDropdown(
    'remarksInput',
    'remarksDropdown',
    remarksList
  );

  // LOCATION (SEPARATE LOGIC)
  setupLocationDropdown();

  document.querySelectorAll(
  '#assetNameInput, #categoryInput, #manufacturerInput, #modelInput, #remarksInput'
).forEach(input => {
  input.disabled = false;
  input.placeholder = "Type to search";
});

});


// Attach functions to window for inline buttons
window.addNewItem = addNewItem;
window.submitAsset = submitAsset;
window.updateGeneratedCode = updateGeneratedCode;

</script>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #010d23, #011e50);
    }
  </style>
</head>

<body class="flex flex-col items-center justify-start min-h-screen p-2 sm:p-4 text-white overflow-x-hidden">

  <!-- Mobile Back Button -->
  <div class="fixed back-btn-mobile z-50 md:hidden">
    <a href="dashboard.html"
      class="flex items-center gap-2 px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold shadow-lg text-sm">
      ⮐ Back
    </a>
  </div>

  <div class="w-full max-w-xl relative px-1 sm:px-0">
    <div class="bg-gradient-to-b from-[#010d23] to-[#011e50] p-8 rounded shadow-md w-full">
      <h1 class="text-2xl font-bold mb-6 text-center text-blue-300">Asset Registration</h1>

      <form id="assetForm" class="space-y-4" onsubmit="event.preventDefault(); submitAsset();">

        <!-- Asset Name -->
        <div class="relative">
          <label class="block font-medium mb-1">Asset Name</label>
          <div class="flex space-x-2">
            <input type="text" id="assetNameInput" class="border p-2 flex-1 rounded bg-[#011a3b] text-white w-full"
              placeholder="Search asset name">
            <button type="button" onclick="addNewItem('assetNames','assetNameInput')"
              class="bg-green-600 text-white px-3 rounded font-bold text-lg">+</button>
          </div>
          <ul id="assetNameDropdown"
            class="absolute z-50 left-0 right-0 bg-[#011a3b] text-white border rounded max-h-48 overflow-y-auto hidden">
          </ul>
        </div>


        <!-- Category -->
        <div class="relative">
          <label class="block font-medium mb-1">Category</label>
          <div class="flex space-x-2">
            <input type="text" id="categoryInput" class="border p-2 flex-1 rounded bg-[#011a3b] text-white w-full"
              placeholder="Search category">
            <button type="button" onclick="addNewItem('categories','categoryInput')"
              class="bg-green-600 text-white px-3 rounded font-bold text-lg">+</button>
          </div>
          <ul id="categoryDropdown"
            class="absolute z-50 left-0 right-0 bg-[#011a3b] text-white border rounded max-h-48 overflow-y-auto hidden">
          </ul>
        </div>

        <!-- Manufacturer -->
        <!-- Manufacturer -->
        <div class="relative">
          <label class="block font-medium mb-1">Manufacturer</label>
          <div class="flex space-x-2">
            <input type="text" id="manufacturerInput" class="border p-2 flex-1 rounded bg-[#011a3b] text-white w-full"
              placeholder="Search manufacturer">

            <button type="button" onclick="addNewItem('manufacturers','manufacturerInput')"
              class="bg-green-600 text-white px-3 rounded font-bold text-lg">+</button>
          </div>

          <ul id="manufacturerDropdown"
            class="absolute z-50 left-0 right-0 bg-[#011a3b] text-white border rounded max-h-48 overflow-y-auto hidden">
          </ul>
        </div>


        <!-- Model / Serial No -->
        <div class="relative">
          <label class="block font-medium mb-1">Model / Serial No</label>
          <div class="flex space-x-2">
            <input type="text" id="modelInput" class="border p-2 flex-1 rounded bg-[#011a3b] text-white w-full"
              placeholder="Search model">
            <button type="button" onclick="addNewItem('models','modelInput')"
              class="bg-green-600 text-white px-3 rounded font-bold text-lg">+</button>
          </div>
          <ul id="modelDropdown"
            class="absolute z-50 left-0 right-0 bg-[#011a3b] text-white border rounded max-h-48 overflow-y-auto hidden">
          </ul>
        </div>


        <!-- Installation Date -->
        <div>
          <label class="block font-medium mb-1">Installation Date</label>
          <input type="date" id="installationDate" class="border p-2 w-full rounded bg-[#011a3b] text-white">
        </div>

        <!-- Location -->
        <div class="relative">
          <label class="block font-medium mb-1">Location</label>
          <input type="text" id="locationInput" class="border p-2 flex-1 rounded bg-[#011a3b] text-white w-full"
            placeholder="Select location">
          <ul id="locationDropdown"
            class="absolute z-50 left-0 right-0 bg-[#011a3b] text-white border rounded max-h-48 overflow-y-auto hidden"></ul>
        </div>

        <!-- AMC Vendor -->
        <div>
          <label class="block font-medium mb-1">AMC Vendor</label>
          <input type="text" id="amcVendor" placeholder="Enter AMC Vendor"
            class="border p-2 w-full rounded bg-[#011a3b] text-white">
        </div>

        <!-- Remarks -->
        <div class="relative">
          <label class="block font-medium mb-1">Remarks</label>
          <div class="flex space-x-2">
            <input type="text" id="remarksInput" class="border p-2 flex-1 rounded bg-[#011a3b] text-white w-full"
              placeholder="Search remarks">
            <button type="button" onclick="addNewItem('remarks','remarksInput')"
              class="bg-green-600 text-white px-3 rounded font-bold text-lg">+</button>
          </div>
          <ul id="remarksDropdown"
            class="absolute z-50 left-0 right-0 bg-[#011a3b] text-white border rounded max-h-48 overflow-y-auto hidden">
          </ul>
        </div>



        <!-- AMC Dates -->
        <div class="flex flex-col md:flex-row md:space-x-2">
          <div class="flex-1">
            <label class="block font-medium mb-1">AMC Start Date</label>
            <input type="date" id="amcStart" class="border p-2 w-full rounded bg-[#011a3b] text-white">
          </div>
          <div class="flex-1">
            <label class="block font-medium mb-1">AMC End Date</label>
            <input type="date" id="amcEnd" class="border p-2 w-full rounded bg-[#011a3b] text-white">
          </div>
        </div>

        <!-- Generated Asset Code -->
        <div id="generatedCode" class="text-center font-bold text-lg mb-4 text-blue-300"></div>

        <!-- Submit -->
        <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded font-bold hover:bg-blue-700">Register
          Asset</button>

      </form>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay"
      class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xl hidden">
      Registering asset...
    </div>
  </div>
</body>

</html>